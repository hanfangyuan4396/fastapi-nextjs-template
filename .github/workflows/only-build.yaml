name: Only Build API

on:
  push:
    branches-ignore:
      - "main"
  workflow_dispatch:

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      api-changed: ${{ steps.changes.outputs.api }}
      web-changed: ${{ steps.changes.outputs.web }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          base: main
          filters: |
            api:
              - 'api/**'
            web:
              - 'web/**'

  api-build:
    runs-on: ubuntu-latest
    needs: check-changes
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: No API changes detected
        if: needs.check-changes.outputs.api-changed != 'true'
        run: |
          echo "ğŸ¯ No changes detected in API directory, skipping Docker image build"
          echo "ğŸ“ Scope checked: api/**"
          echo "âœ… No build required, task completed"

      - name: Set up Docker Buildx
        if: needs.check-changes.outputs.api-changed == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build API Docker image
        if: needs.check-changes.outputs.api-changed == 'true'
        uses: docker/build-push-action@v6
        with:
          context: api
          push: false
          file: api/Dockerfile
          tags: api:local
          platforms: linux/amd64

      - name: API build completed
        if: needs.check-changes.outputs.api-changed == 'true'
        run: |
          echo "ğŸš€ API Docker image build completed"
          echo "ğŸ“¦ Image tag: api:local"


  web-build:
    runs-on: ubuntu-latest
    needs: check-changes
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: No Web changes detected
        if: needs.check-changes.outputs.web-changed != 'true'
        run: |
          echo "ğŸ¯ No changes detected in Web directory, skipping Docker image build"
          echo "ğŸ“ Scope checked: web/**"
          echo "âœ… No build required, task completed"

      - name: Set up Docker Buildx
        if: needs.check-changes.outputs.web-changed == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build Web Docker image
        if: needs.check-changes.outputs.web-changed == 'true'
        uses: docker/build-push-action@v6
        with:
          context: web
          push: false
          file: web/Dockerfile
          tags: web:local
          platforms: linux/amd64

      - name: Web build completed
        if: needs.check-changes.outputs.web-changed == 'true'
        run: |
          echo "ğŸš€ Web Docker image build completed"
          echo "ğŸ“¦ Image tag: web:local"
