# 需求文档：用户信息展示、修改密码与忘记密码

## 1. 背景与目标

现有系统登录后需要在导航栏（Navbar）右侧展示用户信息，并提供用户自助修改密码和忘记密码能力。用户体系以邮箱作为用户名，普通用户只能通过邮箱注册。

目标：
- 在 Navbar 右侧展示用户名称与头像（用户名首字符）。
- 用户点击该区域弹出下拉菜单，提供“修改密码”“退出”。
- 修改密码：输入旧密码与两次新密码完成修改。
- 忘记密码：通过邮箱验证码校验，输入验证码与两次新密码完成重置。

## 2. 用户故事

1. 作为已登录用户，我希望在 Navbar 看到我的用户名和头像，便于确认当前登录账号。
2. 作为已登录用户，我希望在个人菜单中修改密码，提升安全性。
3. 作为未登录用户，我在登录页希望通过“忘记密码”完成密码重置。

## 3. 功能范围

### 3.1 Navbar 用户信息展示
- 展示位置：Navbar 右侧。
- 展示内容：
  - 用户名称（即邮箱）。
  - 头像为用户名首字符（取邮箱首字符，大小写不强制，但建议统一为大写）。
- 交互：点击用户信息区域弹出下拉菜单。
- 下拉菜单项：
  - 修改密码
  - 退出

### 3.2 修改密码（登录态）
- 入口：Navbar 用户菜单。
- 表单字段：
  - 旧密码
  - 新密码
  - 确认新密码
- 规则：
  - 新密码与确认新密码必须一致。
  - 旧密码必须正确。
  - 密码规则沿用现有校验规则，并要求长度最少 6 位。
- 提交成功：
  - 给出成功提示。
  - 自动关闭对话框。
  - 不强制退出登录（如需强制可在实现时确认）。
- 失败提示：
  - 旧密码错误
  - 新密码不一致
  - 其他系统错误

### 3.3 忘记密码（未登录态）
- 入口：登录页新增“忘记密码”入口（按钮/链接）。
- 步骤：
  1. 输入邮箱（用户名）。
  2. 发送邮件验证码。
  3. 输入验证码 + 新密码 + 确认新密码。
  4. 提交重置密码。
- 规则：
  - 邮箱必须存在。
  - 验证码必须匹配且未过期。
  - 新密码与确认新密码必须一致。
  - 新密码长度最少 6 位。
- 提交成功：
  - 给出成功提示。
  - 自动跳转登录页。
- 失败提示：
  - 邮箱不存在
  - 验证码错误/过期
  - 新密码不一致
  - 其他系统错误

## 4. 前端需求（Web）

### 4.1 Navbar 组件
- 展示用户邮箱与头像。
- 头像取邮箱首字符。
- 点击区域弹出下拉菜单。

### 4.2 修改密码对话框
- 弹窗表单含 3 个输入框：旧密码、新密码、确认新密码。
- 表单校验（必填、两次新密码一致）。
- 提交调用后端 API。
- 成功/失败提示。
- 密码输入框支持显示/隐藏切换。

### 4.3 忘记密码流程
- 登录页新增“忘记密码”入口。
- 提供邮件验证码发送按钮与倒计时（如已有统一组件可复用）。
- 输入验证码、新密码、确认新密码。
- 提交调用后端 API。
- 新密码与确认密码输入框支持显示/隐藏切换。

### 4.4 注册流程
- 注册页提供邮箱验证码注册。
- 输入邮箱、验证码、密码、确认密码。
- 提交调用后端 API。
- 密码与确认密码输入框支持显示/隐藏切换。

## 5. 后端需求（API）

### 5.1 修改密码接口
- 仅登录态可用。
- 入参：旧密码、新密码。
- 校验旧密码正确性，更新密码。

### 5.2 忘记密码接口
- 发送验证码：根据邮箱发送验证码邮件。
- 重置密码：校验验证码并更新密码。

### 5.3 当前用户信息接口
- 登录态可用，用于前端展示用户名（邮箱）与头像首字符。
- 返回用户基础信息（id/username/role/is_active/token_version）。

### 5.4 邮件验证码
- 邮件内容包含验证码。
- 验证码具有过期时间与使用次数限制（一次性）。
- 存储方式可复用现有机制或新增表/缓存。

## 6. 数据与模型

- 用户名即邮箱。
- 若已有 `User` 模型与认证机制，复用其字段与登录逻辑。
- 验证码存储结构需支持：邮箱、验证码、过期时间、已使用标记。

## 7. 约束与假设

- 普通用户只能通过邮箱注册，因此用户名即邮箱。
- 若当前系统未集成邮件服务，需要补充邮件发送能力。
- 密码强度规则与现有注册/登录保持一致。

## 8. 验收标准

1. 登录后 Navbar 右侧展示用户邮箱与首字符头像。
2. 点击用户信息弹出菜单，含“修改密码”“退出”。
3. 修改密码流程可正常提交并提示成功/失败。
4. 登录页有“忘记密码”入口，能发送验证码并完成重置。
5. 忘记密码流程中：邮箱校验、验证码校验、两次新密码一致校验均有效。

## 9. 结论与约定

1. 修改密码成功后不需要强制退出登录。
2. 邮件发送服务已有 SMTP 相关配置。
3. 验证码过期时间与发送频率限制参考注册服务的发送邮件逻辑。
